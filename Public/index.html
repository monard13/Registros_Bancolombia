<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Movimientos Financieros</title>
    <style>
        /* Estilos Generales y Variables de Color */
        :root {
            --primary-color: #005A9C;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --white-color: #ffffff;
            --border-color: #dee2e6;
            --font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: var(--font-family);
            background-color: var(--light-color);
            color: var(--dark-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        /* Contenedor Principal */
        .container {
            max-width: 1300px;
            margin: 20px auto;
            background: var(--white-color);
            padding: 25px 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        h1, h2, h3 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
        }

        h1 { font-size: 2.2rem; }
        h2 {
            font-size: 1.8rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        h3 { font-size: 1.5rem; }

        /* Estilos del Dashboard */
        #dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .card {
            background-color: #fdfdfd;
            padding: 20px 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            text-align: center;
            border-left: 5px solid var(--primary-color);
        }
        .card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1rem;
            color: #666;
            font-weight: 600;
        }
        .card p {
            margin-bottom: 0;
            font-size: 2rem;
            font-weight: 700;
        }
        #card-ingresos { border-left-color: var(--success-color); }
        #total-ingresos { color: var(--success-color); }
        #card-egresos { border-left-color: var(--danger-color); }
        #total-egresos { color: var(--danger-color); }
        #card-pendientes { border-left-color: var(--warning-color); }
        #total-pendientes { color: #b8860b; }


        /* Estilos de la SecciÃ³n de ExportaciÃ³n */
        #export-section {
            background-color: #f0f3f5;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 40px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 15px 25px;
        }
        #export-section h3 {
            margin: 0;
            flex-basis: 100%;
            margin-bottom: 10px;
            text-align: left;
        }
        #export-section .form-group-inline {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #export-section label {
            font-weight: 600;
            margin-bottom: 0;
        }
        #export-section input[type="date"] { padding: 8px; }
        #export-csv-btn {
            background-color: var(--success-color);
            margin-left: auto;
        }
        #export-csv-btn:hover { background-color: #218838; }

        /* Formulario de Ingreso de Datos */
        #financial-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: 600; color: #555; }
        input, select, textarea {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 90, 156, 0.2);
        }
        input[type="file"] { padding: 8px; }
        input[type="file"]::file-selector-button {
            font-weight: bold;
            color: var(--primary-color);
            padding: 8px 12px;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius);
            background-color: var(--white-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover { background-color: #eef; }
        textarea { resize: vertical; min-height: 60px; }
        .full-width { grid-column: 1 / -1; }

        /* Botones */
        button {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            color: var(--white-color);
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        button:hover { transform: translateY(-2px); }
        #submit-btn {
            background: linear-gradient(45deg, var(--primary-color), #007bff);
            grid-column: 1 / -1;
        }
        #submit-btn:hover { background: linear-gradient(45deg, #004b82, #0069d9); }
        .action-btn {
            padding: 6px 12px;
            font-size: 0.9rem;
            margin-right: 5px;
        }
        .delete-btn { background-color: var(--danger-color); }
        .delete-btn:hover { background-color: #c82333; }
        .edit-btn { background-color: var(--warning-color); color: #212529; }
        .edit-btn:hover { background-color: #e0a800; }
        .save-btn { background-color: var(--success-color); }
        .save-btn:hover { background-color: #218838; }

        /* Tabla de Registros */
        .table-container { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }
        td { vertical-align: middle; }
        thead th {
            background-color: var(--dark-color);
            color: var(--light-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tbody tr:nth-child(even) { background-color: var(--light-color); }
        tbody tr:hover { background-color: #e2e6ea; }
        td.valor-ingreso { color: var(--success-color); font-weight: bold; }
        td.valor-egreso { color: var(--danger-color); font-weight: bold; }
        .status-pendiente { color: var(--danger-color); font-style: italic; }
        .description-input { width: 95%; }
        .attach-btn {
            background-color: var(--primary-color);
            cursor: pointer;
            display: inline-block;
        }
        .attach-btn:hover { background-color: #004b82; }
        .hidden-file-input { display: none; }

        @media (max-width: 768px) {
            .container { padding: 20px; }
            .card, #export-section .form-group-inline { min-width: 250px; }
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.5rem; }
            #export-csv-btn { margin-left: 0; width: 100%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ðŸ“Š Registro de Movimientos Financieros</h1>

        <div id="dashboard">
            <div class="card" id="card-ingresos"><h3>Total Ingresos (Confirmado)</h3><p id="total-ingresos">$0</p></div>
            <div class="card" id="card-pendientes"><h3>Ingresos Pendientes</h3><p id="total-pendientes">$0</p></div>
            <div class="card" id="card-egresos"><h3>Total Egresos</h3><p id="total-egresos">$0</p></div>
            <div class="card"><h3>Balance General</h3><p id="balance-general">$0</p></div>
        </div>

        <div id="export-section">
            <h3>Exportar Movimientos</h3>
            <div class="form-group-inline"><label for="start-date">Desde:</label><input type="date" id="start-date"></div>
            <div class="form-group-inline"><label for="end-date">Hasta:</label><input type="date" id="end-date"></div>
            <button id="export-csv-btn">Exportar a CSV</button>
        </div>

        <form id="financial-form" autocomplete="off">
            <div class="form-group"><label for="tipo">TIPO</label><select id="tipo" required><option value="Ingreso">Ingreso</option><option value="Egreso">Egreso</option></select></div>
            <div class="form-group"><label for="fecha">FECHA Y HORA</label><input type="datetime-local" id="fecha" required></div>
            <div class="form-group"><label for="banco">BANCO</label><input type="text" id="banco" placeholder="Ej: Banco Principal" required></div>
            <div class="form-group"><label for="valor">VALOR</label><input type="number" id="valor" placeholder="Ej: 150000" required step="any"></div>
            <div class="form-group full-width"><label for="descripcion">DESCRIPCIÃ“N</label><textarea id="descripcion" rows="2" placeholder="Ej: Compra de materiales"></textarea></div>
            <div class="form-group full-width"><label for="comprobante">ADJUNTAR COMPROBANTE (Opcional)</label><input type="file" id="comprobante" accept="image/*,.pdf"></div>
            <button type="submit" id="submit-btn" class="full-width">âž• Agregar Movimiento</button>
        </form>

        <h2>Historial de Movimientos</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Ticket #</th><th>Tipo</th><th>Fecha y Hora</th><th>Banco</th><th>Valor</th><th>DescripciÃ³n</th><th>Imp. 4/1000</th><th>ComisiÃ³n 1%</th><th>Valor LÃ­quido</th><th>Comprobante</th><th>AcciÃ³n</th>
                    </tr>
                </thead>
                <tbody id="transactions-table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('financial-form');
            const tableBody = document.getElementById('transactions-table-body');
            const fechaInput = document.getElementById('fecha');
            const exportBtn = document.getElementById('export-csv-btn');

            // URL del API. Todas las peticiones irÃ¡n a este endpoint.
            const apiUrl = 'https://registros-bancolombia.onrender.com/api/transacciones';
            
            // Almacenamiento local del estado de la aplicaciÃ³n
            let currentTransactions = [];

            const formatCurrency = (value) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(value);

            /**
             * Renderiza la UI completa (tabla y dashboard) a partir del estado actual.
             */
            const renderUI = () => {
                const transactions = currentTransactions;
                tableBody.innerHTML = '';
                let totalIngresosConfirmados = 0, totalIngresosPendientes = 0, totalEgresos = 0;

                if (transactions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="11" style="text-align:center; padding: 20px;">AÃºn no has registrado ningÃºn movimiento.</td></tr>';
                } else {
                    transactions.forEach(tx => {
                        const row = document.createElement('tr');
                        row.dataset.id = tx.id;
                        let imp4por1000 = 0, comision1 = 0, valorLiquido = parseFloat(tx.valor);

                        if (tx.tipo === 'Ingreso') {
                            imp4por1000 = valorLiquido * (4 / 1000);
                            comision1 = (valorLiquido - imp4por1000) * 0.01;
                            valorLiquido = valorLiquido - imp4por1000 - comision1;
                            
                            if(tx.comprobanteUrl) {
                                totalIngresosConfirmados += valorLiquido;
                            } else {
                                totalIngresosPendientes += parseFloat(tx.valor);
                            }
                        } else {
                            totalEgresos += parseFloat(tx.valor);
                        }
                        
                        const fechaObj = new Date(tx.fecha);
                        const formattedFecha = fechaObj.toLocaleString('es-CO', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
                        const valorClass = tx.tipo === 'Ingreso' ? 'valor-ingreso' : 'valor-egreso';

                        let comprobanteHtml = `<label class="action-btn attach-btn">Adjuntar<input type="file" class="hidden-file-input" data-id="${tx.id}" accept="image/*,.pdf"></label>`;
                        if (tx.comprobanteUrl) {
                            comprobanteHtml = `<a href="${tx.comprobanteUrl}" target="_blank" rel="noopener noreferrer">Ver Comprobante</a>`;
                        }

                        let descripcionHtml = `<span>${tx.descripcion}</span>`;
                        if (tx.descripcion === 'PENDIENTE COMPROBANTE') {
                            descripcionHtml = `<span class="status-pendiente">${tx.descripcion}</span>`;
                        }

                        row.innerHTML = `
                            <td>${tx.id}</td><td>${tx.tipo}</td><td>${formattedFecha}</td><td>${tx.banco}</td>
                            <td class="${valorClass}">${formatCurrency(tx.valor)}</td>
                            <td class="description-cell">${descripcionHtml}<input type="text" class="description-input" value="${tx.descripcion}" style="display:none;"></td>
                            <td>${formatCurrency(imp4por1000)}</td><td>${formatCurrency(comision1)}</td>
                            <td class="${valorClass}">${formatCurrency(valorLiquido)}</td>
                            <td class="comprobante-cell">${comprobanteHtml}</td>
                            <td class="action-cell">
                                <button class="action-btn edit-btn" data-id="${tx.id}">Editar</button>
                                <button class="action-btn delete-btn" data-id="${tx.id}">Eliminar</button>
                            </td>`;
                        tableBody.appendChild(row);
                    });
                }
                
                const balance = totalIngresosConfirmados - totalEgresos;
                document.getElementById('total-ingresos').textContent = formatCurrency(totalIngresosConfirmados);
                document.getElementById('total-pendientes').textContent = formatCurrency(totalIngresosPendientes);
                document.getElementById('total-egresos').textContent = formatCurrency(totalEgresos);
                const balanceEl = document.getElementById('balance-general');
                balanceEl.textContent = formatCurrency(balance);
                balanceEl.style.color = balance >= 0 ? 'var(--success-color)' : 'var(--danger-color)';
            };
            
            /**
             * Carga todas las transacciones desde el servidor y actualiza la UI.
             */
            const fetchAndRender = async () => {
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`Error en la red: ${response.statusText}`);
                    currentTransactions = await response.json();
                    renderUI();
                } catch (error) {
                    console.error('Error al cargar transacciones:', error);
                    alert('No se pudieron cargar los datos desde el servidor. Por favor, revisa la conexiÃ³n y el estado del servidor.');
                }
            };

            /**
             * Maneja el envÃ­o del formulario para crear una nueva transacciÃ³n.
             */
            const handleFormSubmit = async (e) => {
                e.preventDefault();
                const file = document.getElementById('comprobante').files[0];
                let descripcion = document.getElementById('descripcion').value.trim();
                if (descripcion === '') descripcion = 'PENDIENTE COMPROBANTE';

                const formData = new FormData();
                formData.append('tipo', document.getElementById('tipo').value);
                formData.append('fecha', document.getElementById('fecha').value);
                formData.append('banco', document.getElementById('banco').value.trim());
                formData.append('valor', document.getElementById('valor').value);
                formData.append('descripcion', descripcion);
                if (file) {
                    formData.append('comprobante', file);
                }

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) throw new Error('Error al guardar la transacciÃ³n.');
                    await fetchAndRender(); // Recargar datos desde el servidor
                    form.reset();
                    setInitialDateTime();
                } catch (error) {
                    console.error('Error al crear transacciÃ³n:', error);
                    alert('No se pudo guardar la nueva transacciÃ³n.');
                }
            };

            /**
             * Maneja todas las acciones de la tabla (Editar, Guardar, Eliminar, Adjuntar).
             */
            const handleTableActions = async (e) => {
                const target = e.target;
                if (!target.dataset.id) return; // Salir si el elemento no tiene un ID de datos
                const id = target.dataset.id;

                // Eliminar
                if (target.classList.contains('delete-btn')) {
                    if (confirm('Â¿EstÃ¡s seguro de que deseas eliminar este movimiento?')) {
                        try {
                            const response = await fetch(`${apiUrl}/${id}`, { method: 'DELETE' });
                            if (!response.ok) throw new Error('Error al eliminar.');
                            await fetchAndRender();
                        } catch (error) {
                            console.error('Error al eliminar:', error);
                            alert('No se pudo eliminar la transacciÃ³n.');
                        }
                    }
                }

                // Activar modo ediciÃ³n
                if (target.classList.contains('edit-btn')) {
                    const row = target.closest('tr');
                    const span = row.querySelector('.description-cell span, .description-cell .status-pendiente');
                    const input = row.querySelector('.description-cell input');
                    span.style.display = 'none';
                    input.style.display = 'block';
                    input.focus();
                    target.textContent = 'Guardar';
                    target.classList.remove('edit-btn');
                    target.classList.add('save-btn');
                } 
                // Guardar cambios de ediciÃ³n
                else if (target.classList.contains('save-btn')) {
                    const row = target.closest('tr');
                    const input = row.querySelector('.description-cell input');
                    let newDescription = input.value.trim() === '' ? 'PENDIENTE COMPROBANTE' : input.value.trim();
                    try {
                        const response = await fetch(`${apiUrl}/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ descripcion: newDescription }),
                        });
                        if (!response.ok) throw new Error('Error al actualizar.');
                        await fetchAndRender();
                    } catch (error) {
                        console.error('Error al guardar descripciÃ³n:', error);
                        alert('No se pudo guardar la descripciÃ³n.');
                    }
                }

                // Adjuntar comprobante a un registro existente
                if (target.classList.contains('hidden-file-input')) {
                    const file = target.files[0];
                    if (file) {
                        const formData = new FormData();
                        formData.append('comprobante', file);
                        try {
                            const response = await fetch(`${apiUrl}/${id}`, {
                                method: 'PUT',
                                body: formData,
                            });
                            if (!response.ok) throw new Error('Error al adjuntar archivo.');
                            await fetchAndRender();
                        } catch (error) {
                            console.error('Error al adjuntar:', error);
                            alert('No se pudo adjuntar el comprobante.');
                        }
                    }
                }
            };

            const exportToCSV = () => {
                const transactionsToExport = currentTransactions; // Usar datos ya cargados
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;

                const filteredTransactions = transactionsToExport.filter(tx => {
                    const txDate = new Date(tx.fecha.split('T')[0]);
                    if (startDate && txDate < new Date(startDate)) return false;
                    if (endDate && txDate > new Date(endDate)) return false;
                    return true;
                });

                if (filteredTransactions.length === 0) {
                    alert('No hay movimientos en el perÃ­odo seleccionado para exportar.');
                    return;
                }

                const headers = ['Ticket #', 'Tipo', 'Fecha y Hora', 'Banco', 'Valor', 'DescripciÃ³n', 'Imp. 4/1000', 'ComisiÃ³n 1%', 'Valor LÃ­quido', 'Estado Comprobante'];
                const csvRows = [headers.join(',')];

                for (const tx of filteredTransactions) {
                    let imp4por1000 = 0, comision1 = 0, valorLiquido = parseFloat(tx.valor);
                    if (tx.tipo === 'Ingreso') {
                        imp4por1000 = valorLiquido * (4 / 1000);
                        comision1 = (valorLiquido - imp4por1000) * 0.01;
                        valorLiquido = valorLiquido - imp4por1000 - comision1;
                    }
                    const estadoComprobante = tx.comprobanteUrl ? 'ADJUNTADO' : 'PENDIENTE';
                    const values = [tx.id, tx.tipo, new Date(tx.fecha).toLocaleString('es-CO'), tx.banco, tx.valor, tx.descripcion, imp4por1000, comision1, valorLiquido, estadoComprobante];
                    csvRows.push(values.map(val => `"${String(val).replace(/"/g, '""')}"`).join(','));
                }

                const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `movimientos_financieros_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            const setInitialDateTime = () => {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                fechaInput.value = now.toISOString().slice(0, 16);
            };

            // --- INICIALIZACIÃ“N ---
            form.addEventListener('submit', handleFormSubmit);
            tableBody.addEventListener('click', handleTableActions);
            tableBody.addEventListener('change', handleTableActions);
            exportBtn.addEventListener('click', exportToCSV);
            
            setInitialDateTime();
            fetchAndRender(); // Cargar datos iniciales al iniciar la app
        });
    </script>
</body>
</html>
